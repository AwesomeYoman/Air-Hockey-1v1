<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Air Hockey 1v1</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

<style>
body { background:#020617; color:white; }
canvas { background:#020617; border:4px solid #334155; border-radius:12px; }
</style>
</head>

<body class="flex flex-col items-center justify-center min-h-screen p-4">

<!-- ===== 初始畫面 ===== -->
<div id="setup" class="space-y-4 w-full max-w-sm">
  <h1 class="text-3xl font-black text-cyan-400 text-center">AIR HOCKEY</h1>

  <input id="name" placeholder="你的名字"
    class="w-full p-3 bg-slate-800 rounded" />

  <button id="btnCreate" disabled
    class="w-full p-4 bg-cyan-600 rounded font-bold disabled:opacity-50">
    建立房間
  </button>

  <div class="flex space-x-2">
    <input id="roomInput" placeholder="房間碼"
      class="flex-1 p-3 bg-slate-800 rounded uppercase" />
    <button id="btnJoin" disabled
      class="p-3 bg-emerald-600 rounded font-bold disabled:opacity-50">
      加入
    </button>
  </div>

  <p id="authStatus" class="text-center text-slate-400 text-sm">
    正在登入 Firebase...
  </p>
</div>

<!-- ===== 等待畫面 ===== -->
<div id="lobby" class="hidden text-center space-y-4">
  <p>等待對手加入</p>
  <div id="roomCode" class="text-5xl font-black text-cyan-400"></div>
</div>

<!-- ===== 遊戲畫面 ===== -->
<div id="game" class="hidden">
  <div class="flex justify-between mb-2">
    <div>對手：<span id="score2">0</span></div>
    <div>你：<span id="score1">0</span></div>
  </div>
  <canvas id="canvas" width="360" height="540"></canvas>
</div>

<script>
/* ================= Firebase 設定 ================= */
const firebaseConfig = {
  apiKey: "AIzaSyALbLez9kTlXPsoPlnpSEgfm3pffWnchwk",
  authDomain: "test-14399.firebaseapp.com",
  projectId: "test-14399",
  storageBucket: "test-14399.firebasestorage.app",
  messagingSenderId: "774194573066",
  appId: "1:774194573066:web:de970617d6331486ea54f3"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ================= 狀態 ================= */
let user = null;
let roomId = null;
let role = null;

const state = {
  p1:{x:0.5,y:0.85},
  p2:{x:0.5,y:0.15},
  puck:{x:0.5,y:0.5,vx:0,vy:0},
  score:{p1:0,p2:0}
};

/* ================= Auth ================= */
auth.signInAnonymously();

auth.onAuthStateChanged(u=>{
  if(!u) return;
  user = u;
  document.getElementById("authStatus").innerText = "已登入，可以開始";
  btnCreate.disabled = false;
  btnJoin.disabled = false;
});

/* ================= UI ================= */
const setup = document.getElementById("setup");
const lobby = document.getElementById("lobby");
const game = document.getElementById("game");

const btnCreate = document.getElementById("btnCreate");
const btnJoin = document.getElementById("btnJoin");

function show(el){
  setup.classList.add("hidden");
  lobby.classList.add("hidden");
  game.classList.add("hidden");
  el.classList.remove("hidden");
}

/* ================= 建立房間 ================= */
btnCreate.onclick = async ()=>{
  if(!user) return;

  roomId = Math.random().toString(36).substr(2,5).toUpperCase();
  role = "host";

  await db.collection("rooms").doc(roomId).set({
    hostId: user.uid,
    status: "waiting",
    p1: state.p1,
    p2: state.p2,
    puck: state.puck,
    score: state.score
  });

  roomCode.innerText = roomId;
  show(lobby);
  listenRoom();
};

/* ================= 加入房間 ================= */
btnJoin.onclick = async ()=>{
  if(!user) return;
  const id = roomInput.value.toUpperCase();
  const ref = db.collection("rooms").doc(id);
  const snap = await ref.get();

  if(!snap.exists) return alert("房間不存在");

  roomId = id;
  role = "client";

  await ref.update({
    clientId: user.uid,
    status: "playing"
  });

  show(game);
  listenRoom();
  loop();
};

/* ================= Firestore 監聽 ================= */
function listenRoom(){
  db.collection("rooms").doc(roomId).onSnapshot(s=>{
    if(!s.exists) return;
    const d = s.data();
    state.p1 = d.p1;
    state.p2 = d.p2;
    state.puck = d.puck;
    state.score = d.score;
    score1.innerText = state.score.p1;
    score2.innerText = state.score.p2;
    if(d.status==="playing") show(game);
  });
}

/* ================= 遊戲 ================= */
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

canvas.addEventListener("mousemove",e=>{
  const r = canvas.getBoundingClientRect();
  const x = (e.clientX-r.left)/canvas.width;
  const y = (e.clientY-r.top)/canvas.height;

  if(role==="host"){
    state.p1.x = x; state.p1.y = Math.max(0.55,y);
    db.collection("rooms").doc(roomId).update({p1:state.p1});
  }else{
    state.p2.x = x; state.p2.y = Math.min(0.45,y);
    db.collection("rooms").doc(roomId).update({p2:state.p2});
  }
});

function loop(){
  if(role==="host"){
    state.puck.x += state.puck.vx;
    state.puck.y += state.puck.vy;
    state.puck.vx*=0.99; state.puck.vy*=0.99;
    db.collection("rooms").doc(roomId).update({puck:state.puck});
  }
  draw();
  requestAnimationFrame(loop);
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawC(state.p1,"#06b6d4");
  drawC(state.p2,"#f43f5e");
  drawC(state.puck,"white",8);
}

function drawC(o,c,r=20){
  ctx.fillStyle=c;
  ctx.beginPath();
  ctx.arc(o.x*canvas.width,o.y*canvas.height,r,0,Math.PI*2);
  ctx.fill();
}
</script>

</body>
</html>
